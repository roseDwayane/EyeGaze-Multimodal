# Dual EEG Transformer Configuration
# Inter-Brain Synchrony Classification: Single / Competition / Cooperation

# ============================================================================
# Ablation Study Configuration
# ============================================================================
ablation:
  # ===== A. Feature Contribution (輸入特徵的貢獻) =====
  # Baseline (Temporal Only): use_spectrogram=false, use_ibs=false
  # + Spectrogram: use_spectrogram=true, use_ibs=false
  # + IBS (Old/Scalar): use_spectrogram=false, use_ibs=true, ibs_mode="scalar"
  # + IBS (New/Robust): use_spectrogram=false, use_ibs=true, ibs_mode="robust"
  # Full Model: use_spectrogram=true, use_ibs=true, ibs_mode="robust"
  use_spectrogram: true        # Enable Spectrogram tokens
  use_ibs: true                # Enable IBS tokens (set false for pure temporal baseline)
  ibs_mode: "robust"           # "robust" (42 tokens) | "scalar" (1 token)

  # ===== B. IBS Tokenizer Design (IBS Tokenizer 的設計驗證) =====
  # Full (Baseline): ibs_instance_norm=true, ibs_feature_type="all"
  # No Instance Norm: ibs_instance_norm=false, ibs_feature_type="all"
  # Phase-only: ibs_instance_norm=true, ibs_feature_type="phase"
  # Amplitude-only: ibs_instance_norm=true, ibs_feature_type="amplitude"
  ibs_instance_norm: true      # Enable Instance Normalization in RobustIBSTokenizer
  ibs_feature_type: "all"      # "all" | "phase" | "amplitude"
  # phase: PLV, PLI, wPLI, Phase_Diff (4 features per band = 24 tokens)
  # amplitude: Coherence, Power_Corr, Time_Corr (3 features per band = 18 tokens)
  # all: All 7 features per band = 42 tokens

  # ===== C. Interaction & Loss (交互機制與 Loss) =====
  # No Cross-Attention: use_cross_attention=false
  # No Contrastive Loss: use_ibs_contrastive=false (in training section)
  # No IBS Cls Head: use_ibs_cls_loss=false (in training section)
  use_cross_attention: true    # Enable CrossBrainAttention module

# ============================================================================
# Model Configuration
# ============================================================================
model:
  in_channels: 32              # Number of EEG channels (32 for this dataset)
  num_labels: 3                # Single, Competition, Cooperation
  d_model: 256                 # Transformer embedding dimension
  num_layers: 6                # Number of Transformer layers
  num_heads: 8                 # Number of attention heads
  d_ff: 1024                   # Feedforward dimension
  conv_kernel_size: 25         # Temporal conv kernel size
  conv_stride: 4               # Temporal conv stride (downsampling factor)
  conv_layers: 2               # Number of temporal conv layers

  # Spectrogram Configuration
  # Note: use_spectrogram is now in ablation section
  spec_n_fft: 128              # STFT FFT window size (~0.5s at 256Hz)
  spec_hop_length: 64          # STFT hop length (50% overlap)
  spec_freq_bins: 64           # Number of frequency bins to use (1-45 Hz range)

  # IBS Configuration
  # Note: use_robust_ibs is now controlled by ablation.ibs_mode

# Data Configuration
data:
  metadata_path: "1_Data/metadata/complete_metadata.json"
  eeg_base_path: "1_Data/datasets/EEGseg"  # Local path "G:/共用雲端硬碟/CNElab_林佳誼_Gaze/B.GazeImage/01.data/EEGseg"
  train_test_split: 0.2        # 20% for test set
  random_seed: 42
  max_samples: null             # Limit samples for quick testing (set to null for all)

  # EEG windowing parameters
  window_size: 1024            # Number of time points per window (4 seconds at 250 Hz)
  stride: 512                  # Stride for sliding window (2 seconds overlap)
  sampling_rate: 256           # EEG sampling rate (Hz)
  filter_low: 1.0              # Low-pass filter frequency (Hz)
  filter_high: 45.0            # High-pass filter frequency (Hz)
  enable_preprocessing: false  # Enable EEG preprocessing (CAR, bandpass, z-score normalization)

  # Class mapping
  class_names: ["Single", "Competition", "Cooperation"]
  label2id:
    "Single": 0
    "Competition": 1
    "Cooperation": 2
  id2label:
    0: "Single"
    1: "Competition"
    2: "Cooperation"

# Training Configuration
training:
  output_dir: "4_Experiments/runs/old_eeg"
  num_train_epochs: 50
  per_device_train_batch_size: 128
  per_device_eval_batch_size: 128

  # Optimization
  learning_rate: 1.0e-4
  weight_decay: 0.01
  dropout: 0.1

  # Loss weights
  use_sym_loss: false                    # Symmetry loss L_sym (關閉)
  use_ibs_loss: false                    # IBS alignment loss L_ibs (關閉)
  use_ibs_cls_loss: true                 # ✅ IBS 直接分類 loss (開啟)
  use_ibs_contrastive: false             # ❌ 暫時關閉（導致 mode collapse）

  lambda_sym: 0.1                        # Weight for symmetry loss
  lambda_ibs: 0.1                        # Weight for IBS alignment loss
  lambda_ibs_cls: 1.0                    # ✅ 提高到 1.0（更強的監督）
  lambda_ibs_contrastive: 0.3            # Weight for IBS contrastive loss

  # Saving
  save_every_n_epochs: 10       # Save checkpoint every N epochs
  metric_for_best_model: "f1"
  greater_is_better: true

  # Logging
  logging_steps: 10
  report_to: ["wandb"]         # Use wandb for logging

# System
system:
  seed: 42
  device: "cuda"               # or "cpu"
  num_workers: 0               # DataLoader workers (Set to 0 to avoid Segmentation Faults)

# Weights & Biases Configuration
wandb:
  project: "Multimodal_EEG"
  run_name: "old_eeg"
  tags:
    - "dual-eeg"
    - "transformer"
    - "ibs-token"
    - "inter-brain-synchrony"
  notes: "Dual EEG Transformer with IBS token for Single/Competition/Cooperation classification"
  entity: null                 # Set your wandb username/team here if needed
